<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <style>
        :root {
            --bg: #f4f7fb;
            --card: #ffffff;
            --text: #17212b;
            --muted: #5f6b7a;
            --accent: #1f8ef1;
            --success: #1a9b4b;
            --border: #d9e2ec;
        }

        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            margin: 0 0 10px;
            font-size: 1.8rem;
        }

        p.subtitle {
            margin: 0 0 18px;
            color: var(--muted);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.92rem;
        }

        input,
        button {
            width: 100%;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 10px;
            font-size: 1rem;
        }

        input:focus {
            outline: 2px solid #b9ddff;
            border-color: var(--accent);
        }

        .button-row {
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            cursor: pointer;
            font-weight: 700;
            border: none;
            color: white;
            background: var(--accent);
        }

        button.secondary {
            background: #8c98a8;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .stat {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            background: #fbfdff;
        }

        .stat h3 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 600;
        }

        .stat p {
            margin: 6px 0 0;
            font-size: 1.15rem;
            font-weight: 700;
        }

        .money {
            color: var(--success);
        }

        .small {
            font-size: 0.86rem;
            color: var(--muted);
            margin-top: 8px;
        }

        .expense-row {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            background: #fbfdff;
        }

        .expense-name {
            font-weight: 600;
        }

        .expense-amount {
            color: var(--muted);
            font-weight: 600;
        }

        .remove-btn {
            width: auto;
            padding: 8px 10px;
            background: #c13f3f;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .chart-wrap {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            background: #fbfdff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Work + Commission Tracker</h1>
        <p class="subtitle">Track daily earnings, reviews, and month totals.</p>

        <section class="card">
            <div class="grid">
                <div>
                    <label for="workDate">Date</label>
                    <input id="workDate" type="date">
                </div>
                <div>
                    <label for="hoursWorked">Hours worked</label>
                    <input id="hoursWorked" type="number" min="0" step="0.25" placeholder="ex: 8">
                </div>
                <div>
                    <label for="phonesRepaired">Phones repaired ($5 each)</label>
                    <input id="phonesRepaired" type="number" min="0" step="1" placeholder="ex: 6">
                </div>
                <div>
                    <label for="insuranceSignups">Insurance signups ($35 each)</label>
                    <input id="insuranceSignups" type="number" min="0" step="1" placeholder="ex: 2">
                </div>
                <div>
                    <label for="totalCustomers">Total customers</label>
                    <input id="totalCustomers" type="number" min="0" step="1" placeholder="ex: 20">
                </div>
                <div>
                    <label for="fiveStarReviews">5-star reviews</label>
                    <input id="fiveStarReviews" type="number" min="0" step="1" placeholder="ex: 7">
                </div>
            </div>

            <div class="button-row">
                <button id="saveBtn" type="button">Save / Update Day</button>
                <button id="clearBtn" type="button" class="secondary">Clear Inputs</button>
            </div>
            <p class="small">Hourly pay rate is fixed at $17.02 per hour.</p>
            <p class="small" id="syncStatus">Cloud sync: not connected. Add your Supabase keys in this file.</p>
        </section>

        <section class="card">
            <h2>Daily Summary</h2>
            <div class="stats">
                <div class="stat">
                    <h3>Hourly Pay</h3>
                    <p class="money" id="dailyHourlyPay">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Commission Pay</h3>
                    <p class="money" id="dailyCommission">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Total Daily Money</h3>
                    <p class="money" id="dailyTotal">$0.00</p>
                </div>
                <div class="stat">
                    <h3>5-Star Rate</h3>
                    <p id="dailyReviewRate">0.00%</p>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Month Totals (Compare)</h2>
            <div class="stats">
                <div class="stat">
                    <h3>This Month Money</h3>
                    <p class="money" id="thisMonthMoney">$0.00</p>
                </div>
                <div class="stat">
                    <h3>This Month 5-Star Reviews</h3>
                    <p id="thisMonthReviews">0</p>
                </div>
                <div class="stat">
                    <h3>This Month 5-Star %</h3>
                    <p id="thisMonthRate">0.00%</p>
                </div>
                <div class="stat">
                    <h3>Last Month Money</h3>
                    <p class="money" id="lastMonthMoney">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Last Month 5-Star Reviews</h3>
                    <p id="lastMonthReviews">0</p>
                </div>
                <div class="stat">
                    <h3>Last Month 5-Star %</h3>
                    <p id="lastMonthRate">0.00%</p>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Monthly Expenses Checklist</h2>
            <div class="grid">
                <div>
                    <label for="billName">Bill name</label>
                    <input id="billName" type="text" placeholder="ex: Rent">
                </div>
                <div>
                    <label for="billAmount">Bill amount ($)</label>
                    <input id="billAmount" type="number" min="0" step="0.01" placeholder="ex: 250">
                </div>
            </div>
            <div class="button-row">
                <button id="addBillBtn" type="button">Add Bill</button>
                <button id="refreshBillsBtn" type="button" class="secondary">Refresh Bills</button>
            </div>
            <p class="small" id="expenseMonthLabel">Bills for this month</p>
            <div id="expenseList"></div>
            <div class="stats">
                <div class="stat">
                    <h3>Total Monthly Bills</h3>
                    <p class="money" id="totalBillsAmount">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Bills Paid</h3>
                    <p id="paidBillsAmount">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Bills Left</h3>
                    <p id="remainingBillsAmount">$0.00</p>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Save Goal Planner</h2>
            <div class="grid">
                <div>
                    <label for="goalAmount">Savings goal after bills ($)</label>
                    <input id="goalAmount" type="number" min="0" step="1" value="1000">
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <h3>Income This Month</h3>
                    <p class="money" id="plannerIncome">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Needed To Hit Goal</h3>
                    <p id="plannerNeeded">$0.00</p>
                </div>
                <div class="stat">
                    <h3>Repairs Needed ($5 each)</h3>
                    <p id="plannerRepairs">0</p>
                </div>
                <div class="stat">
                    <h3>Signups Needed ($35 each)</h3>
                    <p id="plannerSignups">0</p>
                </div>
                <div class="stat">
                    <h3>Hours Needed ($17.02/hr)</h3>
                    <p id="plannerHours">0.00</p>
                </div>
            </div>
        </section>

        <section class="card">
            <h2>Last 12 Months Graph</h2>
            <div class="chart-wrap">
                <canvas id="monthlyChart" height="120"></canvas>
            </div>
            <p class="small">Compares monthly money and 5-star rate for the last 12 months.</p>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const PAY_PER_HOUR = 17.02;
        const PAY_PER_PHONE = 5;
        const PAY_PER_SIGNUP = 35;
        const SUPABASE_URL = "https://twzsvnegkhkhcgjjasik.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_nHkf-Zy3Tirn0XwLnGIsMw_MI-9zNhL";
        const TABLE_NAME = "daily_tracker";
        const EXPENSE_TABLE = "expense_items";
        const EXPENSE_PAYMENT_TABLE = "expense_payments";

        let supabaseClient = null;
        let monthlyChart = null;
        let thisMonthIncome = 0;
        let currentExpenseItems = [];
        let currentPaidMap = new Map();

        const ids = {
            workDate: document.getElementById("workDate"),
            hoursWorked: document.getElementById("hoursWorked"),
            phonesRepaired: document.getElementById("phonesRepaired"),
            insuranceSignups: document.getElementById("insuranceSignups"),
            totalCustomers: document.getElementById("totalCustomers"),
            fiveStarReviews: document.getElementById("fiveStarReviews"),
            saveBtn: document.getElementById("saveBtn"),
            clearBtn: document.getElementById("clearBtn"),
            dailyHourlyPay: document.getElementById("dailyHourlyPay"),
            dailyCommission: document.getElementById("dailyCommission"),
            dailyTotal: document.getElementById("dailyTotal"),
            dailyReviewRate: document.getElementById("dailyReviewRate"),
            thisMonthMoney: document.getElementById("thisMonthMoney"),
            thisMonthReviews: document.getElementById("thisMonthReviews"),
            thisMonthRate: document.getElementById("thisMonthRate"),
            lastMonthMoney: document.getElementById("lastMonthMoney"),
            lastMonthReviews: document.getElementById("lastMonthReviews"),
            lastMonthRate: document.getElementById("lastMonthRate"),
            syncStatus: document.getElementById("syncStatus"),
            billName: document.getElementById("billName"),
            billAmount: document.getElementById("billAmount"),
            addBillBtn: document.getElementById("addBillBtn"),
            refreshBillsBtn: document.getElementById("refreshBillsBtn"),
            expenseMonthLabel: document.getElementById("expenseMonthLabel"),
            expenseList: document.getElementById("expenseList"),
            totalBillsAmount: document.getElementById("totalBillsAmount"),
            paidBillsAmount: document.getElementById("paidBillsAmount"),
            remainingBillsAmount: document.getElementById("remainingBillsAmount"),
            goalAmount: document.getElementById("goalAmount"),
            plannerIncome: document.getElementById("plannerIncome"),
            plannerNeeded: document.getElementById("plannerNeeded"),
            plannerRepairs: document.getElementById("plannerRepairs"),
            plannerSignups: document.getElementById("plannerSignups"),
            plannerHours: document.getElementById("plannerHours"),
            monthlyChart: document.getElementById("monthlyChart")
        };

        const numberInputs = [
            ids.hoursWorked,
            ids.phonesRepaired,
            ids.insuranceSignups,
            ids.totalCustomers,
            ids.fiveStarReviews
        ];

        function getValue(input) {
            const parsed = Number.parseFloat(input.value);
            return Number.isFinite(parsed) && parsed >= 0 ? parsed : 0;
        }

        function currency(value) {
            return `$${value.toFixed(2)}`;
        }

        function percent(numerator, denominator) {
            if (denominator <= 0) {
                return "0.00%";
            }
            return `${((numerator / denominator) * 100).toFixed(2)}%`;
        }

        function calculateFromInputs() {
            const hoursWorked = getValue(ids.hoursWorked);
            const phonesRepaired = getValue(ids.phonesRepaired);
            const insuranceSignups = getValue(ids.insuranceSignups);
            const totalCustomers = getValue(ids.totalCustomers);
            const fiveStarReviews = getValue(ids.fiveStarReviews);

            const hourlyPay = hoursWorked * PAY_PER_HOUR;
            const commissionPay = (phonesRepaired * PAY_PER_PHONE) + (insuranceSignups * PAY_PER_SIGNUP);
            const totalPay = hourlyPay + commissionPay;
            const reviewRate = percent(fiveStarReviews, totalCustomers);

            return {
                hoursWorked,
                phonesRepaired,
                insuranceSignups,
                totalCustomers,
                fiveStarReviews,
                hourlyPay,
                commissionPay,
                totalPay,
                reviewRate
            };
        }

        function renderDailySummary() {
            const daily = calculateFromInputs();
            ids.dailyHourlyPay.textContent = currency(daily.hourlyPay);
            ids.dailyCommission.textContent = currency(daily.commissionPay);
            ids.dailyTotal.textContent = currency(daily.totalPay);
            ids.dailyReviewRate.textContent = daily.reviewRate;
        }

        function clearMonthSummary() {
            ids.thisMonthMoney.textContent = "$0.00";
            ids.thisMonthReviews.textContent = "0";
            ids.thisMonthRate.textContent = "0.00%";
            ids.lastMonthMoney.textContent = "$0.00";
            ids.lastMonthReviews.textContent = "0";
            ids.lastMonthRate.textContent = "0.00%";
        }

        function setSyncStatus(text, isError = false) {
            ids.syncStatus.textContent = text;
            ids.syncStatus.style.color = isError ? "#b11a1a" : "#5f6b7a";
        }

        function isSupabaseConfigured() {
            return (
                SUPABASE_URL &&
                SUPABASE_ANON_KEY &&
                SUPABASE_URL !== "PASTE_YOUR_SUPABASE_URL_HERE" &&
                SUPABASE_ANON_KEY !== "PASTE_YOUR_SUPABASE_ANON_KEY_HERE"
            );
        }

        function initSupabase() {
            if (!isSupabaseConfigured()) {
                setSyncStatus("Cloud sync: not connected. Add your Supabase URL + anon key.", true);
                return false;
            }

            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            setSyncStatus("Cloud sync: connected.");

            return true;
        }

        function monthKeyFromDate(dateString) {
            return dateString ? dateString.slice(0, 7) : "";
        }

        function formatMonthLabel(monthKey) {
            const [year, month] = monthKey.split("-").map(Number);
            const d = new Date(year, month - 1, 1);
            return d.toLocaleString("en-US", { month: "short", year: "2-digit" });
        }

        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
        }

        function getPastMonthKeys(count) {
            const keys = [];
            const now = new Date();
            for (let i = count - 1; i >= 0; i -= 1) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                keys.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`);
            }
            return keys;
        }

        function getMonthStartEnd(monthKey) {
            const [year, month] = monthKey.split("-").map(Number);
            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0);
            const startKey = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, "0")}-01`;
            const endKey = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, "0")}-${String(end.getDate()).padStart(2, "0")}`;
            return { startKey, endKey };
        }

        function summarizeMonth(records, monthKey) {
            let money = 0;
            let reviews = 0;
            let customers = 0;

            for (const item of records) {
                if (monthKeyFromDate(item.day_date) !== monthKey) {
                    continue;
                }
                money += Number(item.totalPay || 0);
                reviews += Number(item.fiveStarReviews || 0);
                customers += Number(item.totalCustomers || 0);
            }

            return { money, reviews, customers };
        }

        function monthRange(dateObj) {
            const start = new Date(dateObj.getFullYear(), dateObj.getMonth(), 1);
            const end = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0);
            const startKey = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, "0")}-01`;
            const endKey = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, "0")}-${String(end.getDate()).padStart(2, "0")}`;
            return { startKey, endKey };
        }

        async function fetchRecordsInRange(startDate, endDate) {
            if (!supabaseClient) {
                return [];
            }

            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select("day_date, total_pay, five_star_reviews, total_customers")
                .gte("day_date", startDate)
                .lte("day_date", endDate)
                .order("day_date", { ascending: true });

            if (error) {
                throw error;
            }

            return (data || []).map((item) => ({
                day_date: item.day_date,
                totalPay: Number(item.total_pay || 0),
                fiveStarReviews: Number(item.five_star_reviews || 0),
                totalCustomers: Number(item.total_customers || 0)
            }));
        }

        async function renderMonthSummary() {
            if (!supabaseClient) {
                clearMonthSummary();
                return;
            }

            const today = new Date();
            const thisMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}`;
            const lastMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthKey = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, "0")}`;

            const thisRange = monthRange(today);
            const lastRange = monthRange(lastMonthDate);

            const [thisRows, lastRows] = await Promise.all([
                fetchRecordsInRange(thisRange.startKey, thisRange.endKey),
                fetchRecordsInRange(lastRange.startKey, lastRange.endKey)
            ]);

            const thisMonth = summarizeMonth(thisRows, thisMonthKey);
            const lastMonth = summarizeMonth(lastRows, lastMonthKey);
            thisMonthIncome = thisMonth.money;

            ids.thisMonthMoney.textContent = currency(thisMonth.money);
            ids.thisMonthReviews.textContent = String(thisMonth.reviews);
            ids.thisMonthRate.textContent = percent(thisMonth.reviews, thisMonth.customers);

            ids.lastMonthMoney.textContent = currency(lastMonth.money);
            ids.lastMonthReviews.textContent = String(lastMonth.reviews);
            ids.lastMonthRate.textContent = percent(lastMonth.reviews, lastMonth.customers);

            renderPlanner();
        }

        async function loadExpenseItems() {
            if (!supabaseClient) {
                currentExpenseItems = [];
                return;
            }

            const { data, error } = await supabaseClient
                .from(EXPENSE_TABLE)
                .select("id, name, amount")
                .eq("is_active", true)
                .order("created_at", { ascending: true });

            if (error) {
                throw error;
            }

            currentExpenseItems = (data || []).map((item) => ({
                id: Number(item.id),
                name: item.name,
                amount: Number(item.amount || 0)
            }));
        }

        async function loadExpensePaidStatus(monthKey) {
            if (!supabaseClient) {
                currentPaidMap = new Map();
                return;
            }

            const { data, error } = await supabaseClient
                .from(EXPENSE_PAYMENT_TABLE)
                .select("expense_id, is_paid")
                .eq("month_key", monthKey);

            if (error) {
                throw error;
            }

            currentPaidMap = new Map();
            (data || []).forEach((item) => {
                currentPaidMap.set(Number(item.expense_id), Boolean(item.is_paid));
            });
        }

        function getExpenseTotals() {
            let total = 0;
            let paid = 0;

            currentExpenseItems.forEach((item) => {
                total += item.amount;
                if (currentPaidMap.get(item.id)) {
                    paid += item.amount;
                }
            });

            return {
                total,
                paid,
                remaining: Math.max(0, total - paid)
            };
        }

        function renderExpenseList() {
            const monthKey = getCurrentMonthKey();
            ids.expenseMonthLabel.textContent = `Bills for ${formatMonthLabel(monthKey)}`;

            if (currentExpenseItems.length === 0) {
                ids.expenseList.innerHTML = "<p class='small'>No bills yet. Add your first bill above.</p>";
                ids.totalBillsAmount.textContent = "$0.00";
                ids.paidBillsAmount.textContent = "$0.00";
                ids.remainingBillsAmount.textContent = "$0.00";
                renderPlanner();
                return;
            }

            ids.expenseList.innerHTML = currentExpenseItems.map((item) => {
                const checked = currentPaidMap.get(item.id) ? "checked" : "";
                return `
                    <div class="expense-row">
                        <input type="checkbox" data-expense-id="${item.id}" ${checked}>
                        <div class="expense-name">${item.name}</div>
                        <div class="expense-amount">${currency(item.amount)}</div>
                        <button class="remove-btn" data-remove-id="${item.id}" type="button">Remove</button>
                    </div>
                `;
            }).join("");

            const totals = getExpenseTotals();
            ids.totalBillsAmount.textContent = currency(totals.total);
            ids.paidBillsAmount.textContent = currency(totals.paid);
            ids.remainingBillsAmount.textContent = currency(totals.remaining);
            renderPlanner();
        }

        async function refreshExpenses() {
            if (!supabaseClient) {
                return;
            }

            const monthKey = getCurrentMonthKey();
            await loadExpenseItems();
            await loadExpensePaidStatus(monthKey);
            renderExpenseList();
        }

        async function addBill() {
            if (!supabaseClient) {
                alert("Supabase is not connected yet.");
                return;
            }

            const name = ids.billName.value.trim();
            const amount = Number.parseFloat(ids.billAmount.value);

            if (!name || !Number.isFinite(amount) || amount < 0) {
                alert("Enter a valid bill name and amount.");
                return;
            }

            const { error } = await supabaseClient
                .from(EXPENSE_TABLE)
                .insert({ name, amount, is_active: true });

            if (error) {
                alert(`Failed to add bill: ${error.message}`);
                return;
            }

            ids.billName.value = "";
            ids.billAmount.value = "";
            await refreshExpenses();
        }

        async function toggleExpensePaid(expenseId, isPaid) {
            const monthKey = getCurrentMonthKey();

            const { error } = await supabaseClient
                .from(EXPENSE_PAYMENT_TABLE)
                .upsert({
                    expense_id: expenseId,
                    month_key: monthKey,
                    is_paid: isPaid
                }, { onConflict: "expense_id,month_key" });

            if (error) {
                alert(`Failed to update bill status: ${error.message}`);
                return;
            }

            currentPaidMap.set(expenseId, isPaid);
            renderExpenseList();
        }

        async function removeBill(expenseId) {
            const { error } = await supabaseClient
                .from(EXPENSE_TABLE)
                .delete()
                .eq("id", expenseId);

            if (error) {
                alert(`Failed to remove bill: ${error.message}`);
                return;
            }

            await refreshExpenses();
        }

        function renderPlanner() {
            const goal = Math.max(0, Number.parseFloat(ids.goalAmount.value) || 0);
            const billsTotal = getExpenseTotals().total;
            const requiredIncome = billsTotal + goal;
            const needed = Math.max(0, requiredIncome - thisMonthIncome);

            ids.plannerIncome.textContent = currency(thisMonthIncome);
            ids.plannerNeeded.textContent = currency(needed);
            ids.plannerRepairs.textContent = String(Math.ceil(needed / PAY_PER_PHONE));
            ids.plannerSignups.textContent = String(Math.ceil(needed / PAY_PER_SIGNUP));
            ids.plannerHours.textContent = (needed / PAY_PER_HOUR).toFixed(2);
        }

        async function render12MonthChart() {
            if (!supabaseClient) {
                return;
            }

            const monthKeys = getPastMonthKeys(12);
            const firstRange = getMonthStartEnd(monthKeys[0]);
            const lastRange = getMonthStartEnd(monthKeys[monthKeys.length - 1]);

            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select("day_date, total_pay, five_star_reviews, total_customers")
                .gte("day_date", firstRange.startKey)
                .lte("day_date", lastRange.endKey)
                .order("day_date", { ascending: true });

            if (error) {
                throw error;
            }

            const aggregate = new Map();
            monthKeys.forEach((key) => {
                aggregate.set(key, { money: 0, reviews: 0, customers: 0 });
            });

            (data || []).forEach((item) => {
                const key = monthKeyFromDate(item.day_date);
                if (!aggregate.has(key)) {
                    return;
                }
                const row = aggregate.get(key);
                row.money += Number(item.total_pay || 0);
                row.reviews += Number(item.five_star_reviews || 0);
                row.customers += Number(item.total_customers || 0);
            });

            const labels = monthKeys.map((key) => formatMonthLabel(key));
            const moneyData = monthKeys.map((key) => aggregate.get(key).money);
            const rateData = monthKeys.map((key) => {
                const row = aggregate.get(key);
                return row.customers > 0 ? Number(((row.reviews / row.customers) * 100).toFixed(2)) : 0;
            });

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ids.monthlyChart, {
                type: "bar",
                data: {
                    labels,
                    datasets: [
                        {
                            label: "Money ($)",
                            data: moneyData,
                            backgroundColor: "rgba(31, 142, 241, 0.55)",
                            borderColor: "rgba(31, 142, 241, 1)",
                            borderWidth: 1,
                            yAxisID: "y"
                        },
                        {
                            label: "5-Star Rate (%)",
                            data: rateData,
                            type: "line",
                            borderColor: "rgba(26, 155, 75, 1)",
                            backgroundColor: "rgba(26, 155, 75, 0.2)",
                            tension: 0.25,
                            yAxisID: "y1"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Money ($)" }
                        },
                        y1: {
                            beginAtZero: true,
                            position: "right",
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: "5-Star Rate (%)" }
                        }
                    }
                }
            });
        }

        async function loadSelectedDateData() {
            const selected = ids.workDate.value;
            if (!supabaseClient || !selected) {
                clearInputs();
                return;
            }

            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select("hours_worked, phones_repaired, insurance_signups, total_customers, five_star_reviews")
                .eq("day_date", selected)
                .maybeSingle();

            if (error) {
                alert(`Failed to load date data: ${error.message}`);
                return;
            }

            const record = data;

            if (!record) {
                numberInputs.forEach((input) => {
                    input.value = "";
                });
                renderDailySummary();
                return;
            }

            ids.hoursWorked.value = record.hours_worked ?? "";
            ids.phonesRepaired.value = record.phones_repaired ?? "";
            ids.insuranceSignups.value = record.insurance_signups ?? "";
            ids.totalCustomers.value = record.total_customers ?? "";
            ids.fiveStarReviews.value = record.five_star_reviews ?? "";

            renderDailySummary();
        }

        function setDefaultDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, "0");
            const dd = String(now.getDate()).padStart(2, "0");
            ids.workDate.value = `${yyyy}-${mm}-${dd}`;
        }

        async function saveDayRecord() {
            if (!supabaseClient) {
                alert("Supabase is not connected yet. Add URL and anon key first.");
                return;
            }

            const selectedDate = ids.workDate.value;
            if (!selectedDate) {
                alert("Please choose a date.");
                return;
            }

            const daily = calculateFromInputs();
            if (daily.fiveStarReviews > daily.totalCustomers) {
                alert("5-star reviews cannot be more than total customers.");
                return;
            }

            const row = {
                day_date: selectedDate,
                hours_worked: daily.hoursWorked,
                phones_repaired: daily.phonesRepaired,
                insurance_signups: daily.insuranceSignups,
                total_customers: daily.totalCustomers,
                five_star_reviews: daily.fiveStarReviews,
                hourly_pay: daily.hourlyPay,
                commission_pay: daily.commissionPay,
                total_pay: daily.totalPay
            };

            const { error } = await supabaseClient
                .from(TABLE_NAME)
                .upsert(row, { onConflict: "day_date" });

            if (error) {
                alert(`Save failed: ${error.message}`);
                return;
            }

            await renderMonthSummary();
            await render12MonthChart();
            alert("Saved.");
        }

        function clearInputs() {
            numberInputs.forEach((input) => {
                input.value = "";
            });
            renderDailySummary();
        }

        ids.saveBtn.addEventListener("click", saveDayRecord);
        ids.clearBtn.addEventListener("click", clearInputs);
        ids.addBillBtn.addEventListener("click", addBill);
        ids.refreshBillsBtn.addEventListener("click", refreshExpenses);
        ids.goalAmount.addEventListener("input", renderPlanner);
        ids.workDate.addEventListener("change", async () => {
            await loadSelectedDateData();
        });
        numberInputs.forEach((input) => input.addEventListener("input", renderDailySummary));
        ids.expenseList.addEventListener("change", async (event) => {
            const target = event.target;
            if (!target.matches("input[type='checkbox'][data-expense-id]")) {
                return;
            }

            const expenseId = Number(target.getAttribute("data-expense-id"));
            await toggleExpensePaid(expenseId, target.checked);
        });

        ids.expenseList.addEventListener("click", async (event) => {
            const target = event.target;
            if (!target.matches("button[data-remove-id]")) {
                return;
            }

            const expenseId = Number(target.getAttribute("data-remove-id"));
            await removeBill(expenseId);
        });

        async function initializeApp() {
            setDefaultDate();
            renderDailySummary();
            clearMonthSummary();
            renderPlanner();

            if (initSupabase()) {
                try {
                    await Promise.all([
                        loadSelectedDateData(),
                        renderMonthSummary(),
                        refreshExpenses(),
                        render12MonthChart()
                    ]);
                } catch (error) {
                    setSyncStatus(`Cloud sync error: ${error.message}`, true);
                }
            }
        }

        initializeApp();
    </script>
</body>
</html>
